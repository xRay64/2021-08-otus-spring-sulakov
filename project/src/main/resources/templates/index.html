<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>gradle db-release initializer</title>
    <style>
        .row {
            margin-top: 10px;
            margin-left: 50px;
        }
    </style>
</head>
<body>
<div style="align-content: center">
    <h1>DB-RELEASE INITIALIZER</h1>
</div>
<div>
    <form id="params">
        <div class="row" th:object="${pluginList}">
            <label for="plugin-select">Choose db-release plugin version: </label>
            <select id="plugin-select" name="pluginSelect">
                <span th:each="plugin: ${pluginList}">
                    <option th:value="${plugin.getVersion()} + ':' + ${plugin.getRepository()}" th:text="${plugin.getVersion()}"></option>
                </span>
            </select>
        </div>
        <div class="row">
            <label for="project-name">Project name: </label>
            <input id="project-name" type="text" name="projectName">
        </div>
        <div class="row">
            <label for="system-name">System name: </label>
            <input id="system-name" type="text" name="systemName">
        </div>
        <div class="row">
            <label for="repository-url">Target repository URL: </label>
            <input id="repository-url" type="text" name="repositoryUrl">
        </div>
        <div id="branch-selector" class="row" hidden>
            <label for="selected-branch">Choose a branch: </label>
            <select id="selected-branch" name="selectedBranch">
                <option value=""></option>
            </select>
        </div>
        <div id="schemas-selector" class="row" hidden>
            <label for="selected-schemas">Choose schemas: </label>
            <select id="selected-schemas" size="10" multiple style="min-width: 200px"></select>
        </div>
        <div class="row">
            <button id="submitButton">Download configs</button>
        </div>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    /////READING BRANCHES
    //setup before functions
    let typingTimer                //timer identifier
    let doneTypingInterval = 1500  //time in ms, 5 second for example
    let $input = $('#repository-url')
    let urlLastValue

    //on keyup, start the countdown
    $input.on('keyup', function () {
        clearTimeout(typingTimer)
        typingTimer = setTimeout(doneTyping, doneTypingInterval)
    });

    //on keydown, clear the countdown
    $input.on('keydown', function () {
        clearTimeout(typingTimer)
    });

    //user is "finished typing," do something
    function doneTyping () {
        currentValue = $input.val()
        if (currentValue !== "" && currentValue !== undefined && urlLastValue !== currentValue) {
            urlLastValue = currentValue
            fillBranchList(currentValue)
        }
    }

    function fillBranchList(urlString) {
        $.getJSON("/repository/branches?repositoryUrl=" + encodeURI(urlString), function (data) {
            let optionsString = ""
            for (const i in data) {
                branchName = data[i].name
                optionsString = optionsString + "<option value=\"" + branchName + "\">" + branchName + "</option>"
            }
            $branchSelecor = $('#selected-branch')
            origHTML = $branchSelecor.html()
            $branchSelecor.html(origHTML + optionsString)
            $('#branch-selector').show()
        })
    }

    ////READING SCHEMAS FROM BRANCH
    let branchLastValue
    $selectedBranch = $(`#selected-branch`)

    $selectedBranch.on('change', function () {
        branchName = $selectedBranch.val()
        repositoryUrl = $('#repository-url').val()

        if (branchName !== undefined && branchName !== "" && branchName !==branchLastValue) {

            branchLastValue = branchName
            $.getJSON(
                "/repository/branchContent?branchName=" + encodeURI(branchName) + "&repositoryUrl=" + encodeURI(repositoryUrl),
                function (data) {
                    let optionsString = ""
                    for (const dataKey in data) {
                        schemaName = data[dataKey].name
                        optionsString = optionsString + "<option value=\"" + schemaName + "\">" + schemaName + "</option>"
                    }
                    $('#selected-schemas').html(optionsString)
                    $('#schemas-selector').show()
                }
            )
        }
    })

    $('#submitButton').click(function (event) {
        event.preventDefault();

        choosenPluginString = $('#plugin-select').val().split(":")
        pluginVesion = choosenPluginString[0]
        pluginRepository = choosenPluginString[1]
        projectName = $('#project-name').val()
        systemName = $('#system-name').val()
        schemasNames = $('#selected-schemas').val()

        $.ajax({
            url: "/process?" +
                "pluginVersion= " + encodeURI(pluginVesion) + "&" +
                "pluginRepository=" + encodeURI(pluginRepository) + "&" +
                "projectName=" + encodeURI(projectName) + "&" +
                "systemName=" + encodeURI(systemName) + "&" +
                "schemasNames=" + encodeURI(schemasNames)
            ,
            cache: false,
            xhr: function () {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 2) {
                        if (xhr.status == 200) {
                            xhr.responseType = "blob";
                        } else {
                            xhr.responseType = "text";
                        }
                    }
                };
                return xhr;
            },
            success: function (data) {
                //Convert the Byte Data to BLOB object.
                var blob = new Blob([data], { type: "application/octetstream" });

                //Check the Browser type and download the File.
                var isIE = false || !!document.documentMode;
                if (isIE) {
                    window.navigator.msSaveBlob(blob, "arch.zip");
                } else {
                    var url = window.URL || window.webkitURL;
                    link = url.createObjectURL(blob);
                    var a = $("<a />");
                    a.attr("download", "arch.zip");
                    a.attr("href", link);
                    $("body").append(a);
                    a[0].click();
                    $("body").remove(a);
                }
            }
        });
    });
</script>
</body>
</html>